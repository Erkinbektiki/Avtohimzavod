{% load static i18n l10n url_i18n phones %}

<!doctype html>
<html lang="{{ LANGUAGE_CODE|default:'ru' }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="icon" href="{% static 'favicon/favicon-32.png' %}" sizes="32x32">
    <link rel="icon" href="{% static 'favicon/favicon-64.png' %}" sizes="64x64">
    <link rel="apple-touch-icon" href="{% static 'favicon/apple-touch-icon.png' %}">
    <meta name="theme-color" content="#0a0a0a">

    <title>{% block title %}Avto_Him_Zavod{% endblock %}</title>

    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    {% block head_extra %}{% endblock %}

    {# ---------- SEO JSON-LD ---------- #}
    {% block seo_jsonld %}
      <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "{{ SITESET.brand|escapejs }}",
        "url": "{{ request.build_absolute_uri|escapejs }}",
        "contactPoint": [{
          "@type": "ContactPoint",
          "telephone": "{{ SITESET.phone_e164|escapejs }}",
          "contactType": "customer service",
          "areaServed": "KG",
          "availableLanguage": ["ru","ky","en"]
        }],
        {% if SITE_RATING.count %}
        "aggregateRating": {
          "@type": "AggregateRating",
          "ratingValue": {{ SITE_RATING.value|floatformat:1|unlocalize }},
          "reviewCount": {{ SITE_RATING.count }}
        },
        {% endif %}
        "department": [
          {% if BRANCHES %}
            {% for b in BRANCHES %}
            {
              "@type": "LocalBusiness",
              "name": "{{ b.name|escapejs }}",
              "telephone": "{{ b.phone_e164|default:SITESET.phone_e164|escapejs }}",
              "address": {
                "@type": "PostalAddress",
                "streetAddress": "{{ b.street_address|escapejs }}",
                "addressLocality": "{{ b.address_locality|escapejs }}",
                "addressRegion": "{{ b.address_region|escapejs }}",
                "addressCountry": "{{ b.address_country|escapejs }}"
              },
              "geo": {
                "@type": "GeoCoordinates",
                "latitude": {{ b.geo_lat|unlocalize }},
                "longitude": {{ b.geo_lng|unlocalize }}
              }
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
          {% else %}
            {
              "@type": "LocalBusiness",
              "name": "{{ SITESET.brand|escapejs }}",
              "telephone": "{{ SITESET.phone_e164|escapejs }}",
              "address": {
                "@type": "PostalAddress",
                "streetAddress": "{{ SITESET.street_address|escapejs }}",
                "addressLocality": "{{ SITESET.address_locality|escapejs }}",
                "addressRegion": "{{ SITESET.address_region|escapejs }}",
                "addressCountry": "{{ SITESET.address_country|escapejs }}"
              }{% if SITESET.geo_lat and SITESET.geo_lng %},
              "geo": {
                "@type": "GeoCoordinates",
                "latitude": {{ SITESET.geo_lat|unlocalize }},
                "longitude": {{ SITESET.geo_lng|unlocalize }}
              }{% endif %}
            }
          {% endif %}
        ]
      }
      </script>
    {% endblock %}
  </head>

  <body class="antialiased bg-neutral-950 text-neutral-100">
    <header class="border-b border-neutral-800">
      <div class="max-w-6xl mx-auto px-4 h-14 flex items-center gap-4">
        <details class="md:hidden ml-auto">
          <summary class="cursor-pointer text-neutral-300">{% trans "Меню" %}</summary>
          <div class="mt-2 absolute left-0 right-0 bg-neutral-950 border-t border-neutral-800 px-4 py-3 space-y-2">
            <a href="{% url 'home' %}" class="block">{% trans "Главная" %}</a>
            <a href="{% url 'service_list' %}" class="block">{% trans "Услуги" %}</a>
            <a href="{% url 'product_list' %}" class="block">{% trans "Товары" %}</a>
            <a href="{% url 'faq_page' %}" class="block">FAQ</a>
            <a href="{% url 'contacts' %}" class="block">{% trans "Контакты" %}</a>
          </div>
        </details>

        <a href="{% url 'home' %}" class="flex items-center gap-2 group">
          <img src="{% static 'img/logo-256.png' %}"
               srcset="{% static 'img/logo-256.png' %} 1x, {% static 'img/logo-512.png' %} 2x"
               alt="{{ SITESET.brand|default:'Avto_Him_Zavod' }}"
               class="h-8 w-auto transition-opacity group-hover:opacity-90"
               onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
          <span class="font-semibold text-lg hidden select-none">Avto_Him_Zavod</span>
        </a>

        {% with p=request.path %}
        <nav class="ml-6 hidden md:flex gap-5 text-neutral-300">
          <a href="{% url 'home' %}" class="hover:text-white {% if p == '/' or p|slice:':4' == '/ru/' %}text-white{% endif %}">{% trans "Главная" %}</a>
          <a href="{% url 'service_list' %}" class="hover:text-white {% if '/services/' in p %}text-white{% endif %}">{% trans "Услуги" %}</a>
          <a href="{% url 'product_list' %}" class="hover:text-white {% if '/products/' in p %}text-white{% endif %}">{% trans "Товары" %}</a>
          <a href="{% url 'faq_page' %}" class="hover:text-white {% if '/faq/' in p %}text-white{% endif %}">FAQ</a>
          <a href="{% url 'contacts' %}" class="hover:text-white {% if '/contacts/' in p %}text-white{% endif %}">{% trans "Контакты" %}</a>
        </nav>
        {% endwith %}

        <div class="ml-auto flex items-center gap-3">
          <form method="post" action="{% url 'set_language' %}" class="inline" id="lang-form">
            <a href="tel:{{ SITESET.phone_e164 }}" class="hidden md:inline text-neutral-300 hover:text-white">
              {{ SITESET.phone_e164|pretty_phone }}
            </a>
            {% csrf_token %}
            <input type="hidden" name="next" id="lang-next" value="{{ request.get_full_path }}">
            <label for="lang" class="sr-only">{% trans "Язык" %}</label>
            <select id="lang" name="language"
                    class="bg-neutral-900 border border-neutral-700 rounded px-2 py-1">
              {% get_current_language as CURRENT_LANG %}
              {% get_available_languages as LANGS %}
              {% for code,name in LANGS %}
              <option value="{{ code }}" {% if code == CURRENT_LANG %}selected{% endif %}>{{ name }}</option>
              {% endfor %}
            </select>
          </form>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8">
      {% if messages %}
        <div class="max-w-6xl mx-auto px-4 pt-4">
          {% for m in messages %}
            <div class="mb-3 px-4 py-2 rounded border
                        {% if m.tags == 'success' %} border-green-600 bg-green-900/20
                        {% elif m.tags == 'error' %} border-red-600 bg-red-900/20
                        {% else %} border-neutral-700 bg-neutral-800/40 {% endif %}">
              {{ m }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% block content %}{% endblock %}
    </main>

    {# ---------- подготовка wa.me ссылки (одна на весь шаблон) ---------- #}
    {% with phone_trim=SITESET.phone_e164|cut:'+' %}
    {% with wa_msg="Здравствуйте! Хочу записаться на диагностику мотора."|urlencode %}
    {% with wa_link="https://wa.me/"|add:phone_trim|add:"?text="|add:wa_msg %}

    <footer class="mt-16 border-t border-neutral-800">
      <div class="max-w-6xl mx-auto px-4 py-10 grid md:grid-cols-4 gap-8 text-sm">

        <div>
          <h3 class="text-neutral-200 font-semibold mb-3">Контакты</h3>
          <p class="mb-2">
            <a href="tel:{{ SITESET.phone_e164 }}" class="hover:underline">
              {{ SITESET.phone_e164|pretty_phone }}
            </a>
          </p>
          <p class="mb-2">
            <a href="{% url 'review_create' %}" class="hover:underline">{% trans "Оставить отзыв" %}</a>
          </p>
          <p class="mb-2">
            <a href="{% if SITESET.whatsapp_link %}{{ SITESET.whatsapp_link }}{% else %}{{ wa_link }}{% endif %}"
               target="_blank" rel="noopener" class="hover:underline">WhatsApp</a>
          </p>
          {% if SITESET.telegram_link %}
          <p class="mb-2"><a href="{{ SITESET.telegram_link }}" target="_blank" rel="noopener" class="hover:underline">Telegram</a></p>
          {% endif %}
          {% if SITESET.email %}
          <p class="mb-2"><a href="mailto:{{ SITESET.email }}" class="hover:underline">{{ SITESET.email }}</a></p>
          {% endif %}
        </div>

        {# ------ если есть филиалы, показываем их; иначе — основной адрес ------ #}
        {% if BRANCHES %}
          <div class="md:col-span-2">
            <h3 class="text-neutral-200 font-semibold mb-3">Наши филиалы</h3>
            <div class="space-y-5">
              {% for b in BRANCHES %}
                <div class="rounded-xl border border-neutral-800 overflow-hidden">
                  <div class="p-4 grid md:grid-cols-2 gap-4 items-start">
                    <div>
                      <div class="text-white font-semibold">{{ b.name }}</div>
                      <div class="text-neutral-400 mt-1">
                        {{ b.street_address }}, {{ b.address_locality }}<br>
                        {{ b.address_region }}, {{ b.address_country }}
                      </div>
                      <div class="mt-3 flex flex-wrap gap-3 text-sm">
                        {% if b.phone_e164 %}
                          <a href="tel:{{ b.phone_e164 }}" class="hover:underline text-neutral-300">
                            {{ b.phone_e164 }}
                          </a>
                        {% endif %}
                        {% if b.whatsapp_link %}
                          <a href="{{ b.whatsapp_link }}" target="_blank" rel="noopener"
                             class="hover:underline text-neutral-300">WhatsApp</a>
                        {% endif %}
                      </div>
                      <div class="mt-2 text-neutral-400 text-xs">
                        Пн–Пт {{ b.hours_mon }} · Сб {{ b.hours_sat }} · Вс {{ b.hours_sun }}
                      </div>
                    </div>
                    <div class="border border-neutral-800 rounded-lg overflow-hidden">
                      <iframe
                        src="https://maps.google.com/maps?q={{ b.geo_lat|unlocalize }},{{ b.geo_lng|unlocalize }}&z=15&output=embed"
                        class="w-full aspect-video" loading="lazy"
                        referrerpolicy="no-referrer-when-downgrade"></iframe>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% else %}
          <div>
            <h3 class="text-neutral-200 font-semibold mb-3">Адрес</h3>
            <p class="text-neutral-400">{{ SITESET.street_address }}, {{ SITESET.address_locality }}</p>
            <p class="text-neutral-400">{{ SITESET.address_region }}, {{ SITESET.address_country }}</p>
            <p class="mt-3 text-neutral-400">Пн–Пт {{ SITESET.hours_mon }} · Сб {{ SITESET.hours_sat }} · Вс {{ SITESET.hours_sun }}</p>
          </div>
          <div class="border border-neutral-800 rounded-xl overflow-hidden">
            {% if SITESET.geo_lat and SITESET.geo_lng %}
              <iframe
                src="https://maps.google.com/maps?q={{ SITESET.geo_lat|unlocalize }},{{ SITESET.geo_lng|unlocalize }}&z=15&output=embed"
                class="w-full aspect-video" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
            {% else %}
              <div class="p-4 text-neutral-500">Карта появится после заполнения координат</div>
            {% endif %}
          </div>
        {% endif %}
      </div>

      <div class="border-t border-neutral-800">
        <div class="max-w-6xl mx-auto px-4 py-6 flex flex-col sm:flex-row items-center justify-between text-neutral-500 text-xs">
          <div>© {{ SITESET.brand }} — Бишкек, Кыргызстан</div>
          <div class="mt-2 sm:mt-0">ИНН / ОГРН (если хотим указать) · Политика конфиденциальности</div>
        </div>
      </div>
    </footer>

    {% block scripts %}
      <script src="{% static 'js/lite-yt.js' %}"></script>
      <script>
      (function () {
        // --- UTM → скрытые поля в лид-формах ---
        const params = new URLSearchParams(window.location.search);
        const utm = { source: params.get('utm_source'), medium: params.get('utm_medium'), campaign: params.get('utm_campaign') };
        try { Object.entries(utm).forEach(([k,v]) => { if (v) localStorage.setItem('utm_'+k, v); }); } catch(e) {}
        function applyUTM(form){
          ['source','medium','campaign'].forEach(k=>{
            const el=form.querySelector(`[name="utm_${k}"]`);
            if(el && !el.value){ el.value=params.get('utm_'+k)||localStorage.getItem('utm_'+k)||''; }
          });
        }
        document.querySelectorAll('form[action$="/lead/"]').forEach(applyUTM);

        // --- Переключение языка: корректный next ---
        const sel=document.getElementById('lang'), nextField=document.getElementById('lang-next'), langForm=document.getElementById('lang-form');
        function buildNextPath(lang){
          const path=window.location.pathname, query=window.location.search||"", hash=window.location.hash||"";
          const stripped=path.replace(/^\/(en|ky)(\/|$)/,"/");
          if(lang==="ru") return stripped+query+hash;
          const p=stripped.startsWith("/")?stripped:"/"+stripped;
          return (`/${lang}${p}`).replace(/\/+$/,"/")+query+hash;
        }
        if(sel && nextField && langForm){
          sel.addEventListener('change', function(){
            nextField.value=buildNextPath(sel.value);
            langForm.submit();
          }, {passive:true});
        }

        // --- Мобильный deep-link WhatsApp с fallback на wa.me (ПК → WhatsApp Web) ---
        (function enhanceWhatsAppLink(){
          var a=document.getElementById('wa-cta-fab'); if(!a) return;
          var isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent); if(!isMobile) return;
          var urlApp="whatsapp://send?phone={{ phone_trim }}&text={{ wa_msg }}";
          a.addEventListener('click', function(e){
            var start=Date.now(); window.location.href=urlApp;
            setTimeout(function(){ if(Date.now()-start<1500){ window.location.href=a.href; } },700);
          }, {passive:true});
        })();
      })();
      </script>
    {% endblock %}

    {# Плавающая панель (мобилка) — WhatsApp + Звонок #}
    <div class="fixed sm:hidden bottom-4 left-1/2 -translate-x-1/2 z-40 flex gap-3">
      <a id="wa-cta-fab" href="{{ wa_link }}" class="px-4 py-3 rounded-full bg-white text-black font-medium shadow-lg">WhatsApp</a>
      <a href="tel:{{ SITESET.phone_e164 }}" class="px-4 py-3 rounded-full bg-neutral-800 border border-neutral-700 text-white shadow-lg">Позвонить</a>
    </div>

    {% endwith %}{% endwith %}{% endwith %}
  </body>
</html>
