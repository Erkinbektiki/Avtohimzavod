{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% load thumbnail %}

{% block title %}{{ service.meta_title|default:service.title }}{% endblock %}

{% block head_extra %}
  <meta name="description" content="{{ service.meta_description|default:service.short_desc|striptags }}">
  <meta property="og:type" content="website">
  <meta property="og:title" content="{{ service.meta_title|default:service.title }}">
  <meta property="og:description" content="{{ service.meta_description|default:service.short_desc|striptags }}">
  {% if service.image %}
    <meta property="og:image" content="{{ service.image.url }}">
    <meta name="twitter:image" content="{{ service.image.url }}">
  {% endif %}
  <meta name="twitter:card" content="summary_large_image">
{% endblock %}

{% block seo_jsonld %}
<!-- Service -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Service",
  "name": "{{ service.title|escapejs }}",
  "description": "{{ service.short_desc|default:service.title|escapejs }}",
  {% if service.price_from %}
    "offers": {
      "@type": "Offer",
      "priceCurrency": "KGS",
      "price": {{ service.price_from }}
    },
  {% endif %}
  "provider": {
    "@type": "LocalBusiness",
    "name": "АвтоХимЗавод",
    "telephone": "{{ SITESET.phone_e164 }}",
    "url": "{{ request.build_absolute_uri }}",
    "areaServed": "Bishkek, Kyrgyzstan",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Bishkek",
      "addressCountry": "KG"
    }
  }
}
</script>

<!-- FAQPage -->
{% if faqs %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {% for q in faqs %}
    {
      "@type": "Question",
      "name": "{{ q.question|escapejs }}",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "{{ q.answer|escapejs }}"
      }
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>
{% endif %}

<!-- BreadcrumbList -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {"@type":"ListItem","position":1,"name":"{% trans 'Главная' %}","item":"{% url 'home' %}"},
    {"@type":"ListItem","position":2,"name":"{% trans 'Услуги' %}","item":"{% url 'service_list' %}"},
    {"@type":"ListItem","position":3,"name":"{{ service.title|escapejs }}","item":"{{ request.build_absolute_uri|escapejs }}"}
  ]
}
</script>
{% endblock %}

{% block content %}
<nav aria-label="Breadcrumb" class="mb-4 text-sm text-neutral-400">
  <a href="{% url 'home' %}" class="hover:underline">{% trans "Главная" %}</a>
  <span class="mx-2">/</span>
  <a href="{% url 'service_list' %}" class="hover:underline">{% trans "Услуги" %}</a>
  <span class="mx-2">/</span>
  <span class="text-neutral-200">{{ service.title }}</span>
</nav>

<article class="grid md:grid-cols-3 gap-8">
  <div class="md:col-span-2">
    <h1 class="text-3xl font-semibold">{{ service.title }}</h1>
    {% if service.image %}
      <img src="{{ service.image.url }}" alt="{{ service.title }}" class="mt-4 w-full rounded-xl border border-neutral-800">
    {% endif %}
    {% if service.body %}
      <div class="prose prose-invert mt-6 max-w-none">{{ service.body|safe }}</div>
    {% endif %}

    {% if cases %}
      <h2 class="text-2xl font-semibold mt-10">{% trans "Кейсы до и после" %}</h2>
      <div class="grid md:grid-cols-2 gap-6 mt-4">
        {% for c in cases %}
        <div class="border border-neutral-800 rounded-xl overflow-hidden">
          <div class="grid grid-cols-2 gap-0">
            {% thumbnail c.before_image "800x450" crop="center" as im %}
              {% thumbnail c.before_image "1600x900" crop="center" as im2 %}
              <img
                  src="{{ im.url }}"
                  srcset="{{ im.url }} 1x, {{ im2.url }} 2x"
                  width="{{ im.width }}" height="{{ im.height }}"
                  alt="before" class="w-full aspect-video object-cover" loading="lazy" decoding="async">
              {% endthumbnail %}
            {% endthumbnail %}
            {% thumbnail c.after_image "800x450" crop="center" as im %}
              {% thumbnail c.after_image "1600x900" crop="center" as im2 %}
              <img
                  src="{{ im.url }}"
                  srcset="{{ im.url }} 1x, {{ im2.url }} 2x"
                  width="{{ im.width }}" height="{{ im.height }}"
                  alt="after" class="w-full aspect-video object-cover" loading="lazy" decoding="async">
              {% endthumbnail %}
            {% endthumbnail %}
          </div>
          {% if c.metric_label %}
            <div class="p-3 text-sm text-neutral-300">
              {{ c.metric_label }}: {{ c.metric_before }} → {{ c.metric_after }}
            </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <aside>
    {% if service.price_from %}
      <div class="p-4 border border-neutral-800 rounded-xl">
        <div class="text-neutral-300 text-sm">{% trans "Цена от" %}</div>
        <div class="text-2xl font-semibold">{{ service.price_from }} {% trans "сом" %}</div>
        
        {% include "components/price_card.html" with service=service show_cta=True only %}
        
        {% with form=form_lead %}
          {% include "partials/lead_form.html" %}
        {% endwith %}
        
        <div class="mt-3 text-sm text-neutral-400">
          {% trans "Есть вопросы? Звоните" %}
          <a href="tel:{{ SITESET.phone_e164 }}" class="underline">
            {{ SITESET.phone_e164|pretty_phone }}
          </a>
        </div>
      </div>
    {% endif %}

    {% if faqs %}
      <div class="mt-6">
        <h3 class="text-lg font-semibold mb-3">{% trans "Вопросы и ответы" %}</h3>
        <div class="space-y-3">
          {% for q in faqs %}
          <details class="border border-neutral-800 rounded">
            <summary class="px-3 py-2 cursor-pointer">{{ q.question }}</summary>
            <div class="px-3 py-2 text-neutral-300">{{ q.answer|linebreaks }}</div>
          </details>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </aside>
</article>
{% endblock %}