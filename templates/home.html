{% extends "base.html" %}
{% load i18n l10n phones %}

{# --- TITLE --- #}
{% block title %}
  {% blocktrans trimmed with brand=SITESET.brand %}
    Диагностика мотора в Бишкеке — {{ brand }}
  {% endblocktrans %}
{% endblock %}

{# --- META DESCRIPTION (используем блок из base.html, чтобы не дублировать) --- #}
{% block meta_description %}
  {% blocktrans trimmed asvar meta_description %}
    Профессиональная диагностика мотора в Бишкеке: быстрая точная проверка двигателя на современном оборудовании. Понятные результаты и план ремонта уже после первого визита.
  {% endblocktrans %}
  <meta name="description" content="{{ meta_description }}">
{% endblock %}

{# --- OG TITLE (base.html сам подхватит og:description из meta_description) --- #}
{% block og_title %}
  {% blocktrans trimmed with brand=SITESET.brand asvar og_title %}
    Диагностика мотора в Бишкеке — {{ brand }}
  {% endblocktrans %}
  {{ og_title }}
{% endblock %}

{# head_extra не нужен для OG — base уже всё рендерит; оставим пустым #}
{% block head_extra %}{% endblock %}

{% block content %}
<section class="py-16">
  <div class="grid md:grid-cols-2 gap-10 items-start">
    <div>
      <h1 class="text-3xl md:text-5xl font-semibold leading-tight">
        {% trans "Диагностика мотора в Бишкеке" %}
      </h1>

      <p class="mt-4 text-neutral-300">
        {% blocktrans trimmed %}
          Профессиональная проверка двигателя: компьютерная диагностика, замер компрессии,
          эндоскопия цилиндров. Чёткие выводы и план работ уже после первого визита.
        {% endblocktrans %}
      </p>

      {# CTA кнопки #}
      <div class="mt-6 grid sm:grid-cols-3 gap-3 max-w-xl">
        {% with wa_text="Здравствуйте! Хочу записаться на диагностику мотора."|urlencode %}
          <a href="{% if SITESET.whatsapp_link %}{{ SITESET.whatsapp_link }}{% else %}https://wa.me/{{ SITESET.phone_e164|cut:'+' }}{% endif %}?text={{ wa_text }}"
             class="px-4 py-3 rounded bg-white text-black font-medium text-center"
             target="_blank" rel="noopener">
            {% trans "Записаться в WhatsApp" %}
          </a>
        {% endwith %}

        {% if SITESET.telegram_link %}
          <a href="{{ SITESET.telegram_link }}"
             class="px-4 py-3 rounded border border-neutral-600 text-center"
             target="_blank" rel="noopener">
            {% trans "Telegram" %}
          </a>
        {% endif %}

        <a href="tel:{{ SITESET.phone_e164 }}"
           class="px-4 py-3 rounded border border-neutral-600 text-center">
          {% blocktrans with phone=SITESET.phone_e164|pretty_phone %}
            Позвонить {{ phone }}
          {% endblocktrans %}
        </a>
      </div>

      <p class="mt-3 text-neutral-400 text-sm">
        {% trans "Или оставьте заявку — перезвоним в течение 10 минут." %}
      </p>

      {# Форма лида #}
      {% include "partials/lead_form.html" with form=form_lead %}

      <ul class="mt-6 flex flex-wrap gap-4 text-sm text-neutral-400">
        <li>{% trans "5+ лет в Бишкеке" %}</li>
        <li>{% trans "500+ обслуженных авто" %}</li>
        <li>{% trans "Гарантия на работы" %}</li>
      </ul>

      {# Рейтинг #}
      <div class="mt-2 flex items-center gap-2 text-neutral-300">
        <div aria-label="{% trans 'Рейтинг' %}" class="flex">
          {% for i in "12345" %}
            <span class="text-lg">
              {% if forloop.counter <= SITE_RATING.value|floatformat:0 %}★{% else %}☆{% endif %}
            </span>
          {% endfor %}
        </div>
        <span class="text-sm text-neutral-400">
          {% blocktrans with rating=SITE_RATING.value count=SITE_RATING.count %}
            {{ rating }} / 5 · {{ count }} отзывов
          {% endblocktrans %}
        </span>
      </div>
    </div>

    {# Видео #}
    <div class="aspect-video bg-neutral-900 rounded-xl border border-neutral-800 overflow-hidden relative">
      {% if SITESET.hero_youtube_id %}
        {% trans "Смотреть: Диагностика мотора" as yt_label %}
        <lite-youtube
          videoid="{{ SITESET.hero_youtube_id }}"
          style="width:100%; height:100%; display:block;"
          playlabel="{{ yt_label }}">
        </lite-youtube>
      {% else %}
        <div class="w-full h-full flex items-center justify-center text-neutral-500 text-center p-6">
          {% trans "Добавьте ID видео в SITESET.hero_youtube_id, чтобы показать ролик о диагностике" %}
        </div>
      {% endif %}
    </div>
  </div>
</section>

{# Отзывы #}
{% if reviews %}
<section class="py-10">
  <h2 class="text-xl font-semibold mb-4">{% trans "Отзывы клиентов" %}</h2>
  <div class="grid md:grid-cols-2 gap-4">
    {% for r in reviews %}
      <div class="border border-neutral-800 rounded-lg p-4">
        <div class="font-medium">{{ r.author }}</div>
        <div class="text-amber-400 text-sm mb-2">
          {% for i in "12345" %}{% if forloop.counter <= r.rating %}★{% else %}☆{% endif %}{% endfor %}
        </div>
        <div class="text-neutral-300">{{ r.text|linebreaksbr }}</div>
        {% if r.source_url %}
          <a href="{{ r.source_url }}" class="text-neutral-400 text-sm hover:underline mt-2 inline-block" target="_blank" rel="noopener">
            {{ r.get_source_display }}
          </a>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</section>
{% endif %}
{% endblock %}

{# JSON-LD для SEO — фикс имени переменной рейтинга и числовых фильтров #}
{% block seo_jsonld %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Service",
  "serviceType": "{% trans 'Диагностика мотора' %}",
  "areaServed": "{% trans 'Бишкек, Кыргызстан' %}",
  "provider": {
    "@type": "LocalBusiness",
    "name": "{{ SITESET.brand|escapejs }}",
    "telephone": "{{ SITESET.phone_e164|escapejs }}",
    "url": "{{ request.build_absolute_uri|escapejs }}",
    "address": {
      "@type": "PostalAddress",
      "streetAddress": "{{ SITESET.street_address|escapejs }}",
      "addressLocality": "{{ SITESET.address_locality|escapejs }}",
      "addressRegion": "{{ SITESET.address_region|escapejs }}",
      "addressCountry": "{{ SITESET.address_country|escapejs }}"
    }
  }{% if SITE_RATING.count %},
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": {{ SITE_RATING.value|floatformat:1|unlocalize }},
    "reviewCount": {{ SITE_RATING.count }}
  }{% endif %}{% if SITESET.og_image %},
  "image": "{{ SITESET.og_image.url|escapejs }}"{% endif %}
}
</script>
{% endblock %}

{# Ничего не подключаем дополнительно — base.html уже грузит lite-yt.js #}
